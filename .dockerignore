# ---------- Builder ----------
FROM node:20-alpine AS builder

WORKDIR /app

# Copiamos solo manifiestos primero para cacheo
COPY package.json package-lock.json ./
# Importante: si tu server/client importan cosas por rutas relativas, el build necesita el árbol
COPY client ./client
COPY server ./server
COPY shared ./shared
COPY tsconfig.json vite.config.ts postcss.config.js tailwind.config.ts ./
# (Opcionales si existen)
COPY components.json drizzle.config.ts ./ 2>/dev/null || true

# Instala deps (dev + prod) para poder compilar
RUN npm ci

# Build (usa tus scripts del package.json)
# - Vite: construye el frontend (por defecto a dist/)
# - esbuild: bundla server a dist/index.js (según tu script)
RUN npm run build

# ---------- Runtime ----------
FROM node:20-alpine AS runner

ENV NODE_ENV=production
WORKDIR /app

# Copia solo lo necesario para instalar deps de producción
COPY package.json package-lock.json ./

# Instala SOLO prod deps (express, etc. externos al bundle)
RUN npm ci --omit=dev && npm cache clean --force

# Copiamos artefactos listos
COPY --from=builder /app/dist ./dist

# Usuario no root por seguridad
RUN addgroup -S nodeapp && adduser -S nodeapp -G nodeapp
USER nodeapp

EXPOSE 3000
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 CMD node -e "fetch('http://127.0.0.1:3000/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"

CMD ["node", "dist/index.js"]
